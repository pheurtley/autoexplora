generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ==================== Email Tokens ====================

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())

  @@unique([email, token])
  @@index([email])
  @@index([token])
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())

  @@unique([email, token])
  @@index([email])
  @@index([token])
}

model Dealer {
  id              String       @id @default(cuid())
  slug            String       @unique
  businessName    String
  tradeName       String
  rut             String       @unique
  type            DealerType
  email           String
  phone           String
  whatsapp        String?
  website         String?
  address         String
  regionId        String
  comunaId        String?
  logo            String?
  logoPublicId    String?
  banner          String?
  bannerPublicId  String?
  description     String?
  schedule        Json?
  status          DealerStatus @default(PENDING)
  verifiedAt      DateTime?
  rejectionReason String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  comuna          Comuna?      @relation(fields: [comunaId], references: [id])
  region          Region       @relation(fields: [regionId], references: [id])
  users           User[]
  vehicles        Vehicle[]
  siteConfig      DealerSiteConfig?
  leads           DealerLead[]
  contactEvents   ContactEvent[]
  trackingEvents  TrackingEvent[]
  // CRM Relations
  messageTemplates   MessageTemplate[]
  autoResponseConfig AutoResponseConfig?

  @@index([status])
  @@index([type])
  @@index([regionId])
  @@index([slug])
}

model User {
  id                  String         @id @default(cuid())
  name                String?
  email               String?        @unique
  emailVerified       DateTime?
  image               String?
  password            String?
  phone               String?
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  banReason           String?
  bannedAt            DateTime?
  role                Role           @default(USER)
  suspendedUntil      DateTime?
  dealerId            String?
  dealerRole          DealerRole?
  accounts            Account[]
  buyerConversations  Conversation[] @relation("BuyerConversations")
  sellerConversations Conversation[] @relation("SellerConversations")
  favorites           Favorite[]
  messages            Message[]
  reportsMade         Report[]       @relation("ReportedBy")
  reportsResolved     Report[]       @relation("ResolvedBy")
  sessions            Session[]
  dealer              Dealer?        @relation(fields: [dealerId], references: [id])
  moderatedVehicles   Vehicle[]      @relation("ModeratedBy")
  vehicles            Vehicle[]
  // CRM Relations
  assignedLeads       DealerLead[]   @relation("AssignedLeads")
  leadActivities      LeadActivity[] @relation("LeadActivities")
  notifications       Notification[]
  assignedTasks       LeadTask[]     @relation("AssignedTasks")

  @@index([email])
  @@index([role])
  @@index([dealerId])
}

model Vehicle {
  id              String           @id @default(cuid())
  title           String
  slug            String           @unique
  description     String?
  price           Int
  currency        String           @default("CLP")
  negotiable      Boolean          @default(false)
  vehicleType     VehicleType
  category        VehicleCategory
  condition       VehicleCondition
  brandId         String
  modelId         String
  year            Int
  mileage         Int
  fuelType        FuelType
  transmission    Transmission
  engineSize      String?
  color           String?
  doors           Int?
  seats           Int?
  plateEnding     String?
  technicalReview DateTime?
  regionId        String
  comunaId        String?
  contactPhone    String
  contactWhatsApp String?
  showPhone       Boolean          @default(true)
  status          ListingStatus    @default(ACTIVE)
  featured        Boolean          @default(false)
  views           Int              @default(0)
  userId          String
  publishedAt     DateTime         @default(now())
  expiresAt       DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  moderatedAt     DateTime?
  moderatedById   String?
  rejectionReason String?
  dealerId        String?
  versionId       String?
  conversations   Conversation[]
  favorites       Favorite[]
  reports         Report[]
  brand           Brand            @relation(fields: [brandId], references: [id])
  comuna          Comuna?          @relation(fields: [comunaId], references: [id])
  dealer          Dealer?          @relation(fields: [dealerId], references: [id])
  model           Model            @relation(fields: [modelId], references: [id])
  moderatedBy     User?            @relation("ModeratedBy", fields: [moderatedById], references: [id])
  region          Region           @relation(fields: [regionId], references: [id])
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  version         Version?         @relation(fields: [versionId], references: [id])
  images          VehicleImage[]
  dealerLeads     DealerLead[]
  contactEvents   ContactEvent[]
  trackingEvents  TrackingEvent[]
  // CRM Relations
  opportunities   Opportunity[]
  testDrives      TestDrive[]

  @@index([userId])
  @@index([brandId])
  @@index([modelId])
  @@index([versionId])
  @@index([regionId])
  @@index([vehicleType])
  @@index([status])
  @@index([price])
  @@index([year])
  @@index([publishedAt])
  @@index([slug])
  @@index([dealerId])
}

model VehicleImage {
  id        String   @id @default(cuid())
  url       String
  publicId  String
  isPrimary Boolean  @default(false)
  order     Int      @default(0)
  vehicleId String
  createdAt DateTime @default(now())
  vehicle   Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId])
}

model Brand {
  id           String        @id @default(cuid())
  name         String        @unique
  slug         String        @unique
  logo         String?
  vehicleTypes VehicleType[] @default([])
  models       Model[]
  vehicles     Vehicle[]

  @@index([slug])
}

model Model {
  id           String        @id @default(cuid())
  name         String
  slug         String
  brandId      String
  vehicleTypes VehicleType[] @default([])
  brand        Brand         @relation(fields: [brandId], references: [id], onDelete: Cascade)
  vehicles     Vehicle[]
  versions     Version[]

  @@unique([brandId, slug])
  @@index([brandId])
}

model Version {
  id           String    @id @default(cuid())
  name         String
  slug         String
  engineSize   String?
  horsePower   Int?
  transmission String?
  drivetrain   String?
  trimLevel    String?
  modelId      String
  vehicles     Vehicle[]
  model        Model     @relation(fields: [modelId], references: [id], onDelete: Cascade)

  @@unique([modelId, slug])
  @@index([modelId])
}

model Region {
  id             String          @id @default(cuid())
  name           String          @unique
  slug           String          @unique
  order          Int
  comunas        Comuna[]
  dealers        Dealer[]
  vehicles       Vehicle[]
  trackingEvents TrackingEvent[]

  @@index([slug])
}

model Comuna {
  id       String    @id @default(cuid())
  name     String
  slug     String
  regionId String
  region   Region    @relation(fields: [regionId], references: [id], onDelete: Cascade)
  dealers  Dealer[]
  vehicles Vehicle[]

  @@unique([regionId, slug])
  @@index([regionId])
}

model Favorite {
  id        String   @id @default(cuid())
  userId    String
  vehicleId String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  vehicle   Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@unique([userId, vehicleId])
  @@index([userId])
  @@index([vehicleId])
}

model Conversation {
  id                 String    @id @default(cuid())
  vehicleId          String
  buyerId            String
  sellerId           String
  lastMessageAt      DateTime  @default(now())
  buyerUnreadCount   Int       @default(0)
  sellerUnreadCount  Int       @default(0)
  isArchivedByBuyer  Boolean   @default(false)
  isArchivedBySeller Boolean   @default(false)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  buyer              User      @relation("BuyerConversations", fields: [buyerId], references: [id], onDelete: Cascade)
  seller             User      @relation("SellerConversations", fields: [sellerId], references: [id], onDelete: Cascade)
  vehicle            Vehicle   @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  messages           Message[]
  lead               DealerLead?

  @@unique([buyerId, vehicleId])
  @@index([buyerId])
  @@index([sellerId])
  @@index([lastMessageAt])
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  senderId       String
  content        String
  isRead         Boolean      @default(false)
  readAt         DateTime?
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User         @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
}

model Report {
  id           String       @id @default(cuid())
  vehicleId    String
  reporterId   String
  reason       ReportReason
  description  String?
  status       ReportStatus @default(PENDING)
  resolvedById String?
  resolvedAt   DateTime?
  resolution   String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  reporter     User         @relation("ReportedBy", fields: [reporterId], references: [id])
  resolvedBy   User?        @relation("ResolvedBy", fields: [resolvedById], references: [id])
  vehicle      Vehicle      @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId])
  @@index([reporterId])
  @@index([status])
  @@index([createdAt])
}

model SiteConfig {
  id                    String   @id @default("default")
  siteName              String   @default("AutoExplora.cl")
  siteTagline           String?
  logo                  String?
  favicon               String?
  contactEmail          String?
  contactPhone          String?
  whatsapp              String?
  address               String?
  facebook              String?
  instagram             String?
  twitter               String?
  youtube               String?
  heroTitle             String?
  heroSubtitle          String?
  footerText            String?
  updatedAt             DateTime @updatedAt
  accentColor           String   @default("#f97316")
  footerLogoSize        String   @default("md")
  googleAnalyticsId     String?
  headerLogoSize        String   @default("md")
  maintenanceMessage    String?
  maintenanceMode       Boolean  @default(false)
  maxImagesPerVehicle   Int      @default(10)
  metaDescription       String?
  ogImage               String?
  primaryColor          String   @default("#2563eb")
  showSiteNameInFooter  Boolean  @default(true)
  showSiteNameInHeader  Boolean  @default(true)
  showWhatsAppButton    Boolean  @default(true)
  ctaButtonText         String   @default("Publicar mi vehículo")
  ctaSubtitle           String   @default("Publica tu auto, moto o vehículo comercial en minutos y conecta con compradores interesados.")
  ctaTitle              String   @default("¿Listo para vender tu vehículo?")
  featuredVehiclesLimit Int      @default(8)
  popularBrandsLimit    Int      @default(12)
  recentVehiclesLimit   Int      @default(8)
  showCTASection        Boolean  @default(true)
  showFeaturedVehicles  Boolean  @default(true)
  showPopularBrands     Boolean  @default(true)
  showRecentVehicles    Boolean  @default(true)
  showTopDealers        Boolean  @default(true)
  showWhyChooseUs       Boolean  @default(true)
  topDealersLimit       Int      @default(6)
  whyChooseUsSubtitle   String   @default("Somos el marketplace de vehículos más confiable de Chile")
  whyChooseUsTitle      String   @default("¿Por qué elegir AutoExplora.cl?")
  // Why Us Features (3 items)
  whyUsFeature1Icon     String   @default("Shield")
  whyUsFeature1Title    String   @default("Compra segura")
  whyUsFeature1Desc     String   @default("Verificamos a los vendedores y te ayudamos en todo el proceso de compra para que sea una experiencia segura.")
  whyUsFeature2Icon     String   @default("Zap")
  whyUsFeature2Title    String   @default("Vende rápido")
  whyUsFeature2Desc     String   @default("Publica tu vehículo en minutos y llega a miles de compradores potenciales en todo Chile.")
  whyUsFeature3Icon     String   @default("Users")
  whyUsFeature3Title    String   @default("Gran comunidad")
  whyUsFeature3Desc     String   @default("Más de 50,000 vehículos disponibles y una comunidad activa de compradores y vendedores.")
}

model FaqTemplate {
  id        String   @id @default(cuid())
  pageType  String   // "brand" | "model" | "region"
  question  String
  answer    String
  order     Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([pageType])
  @@index([pageType, order])
}

enum Role {
  USER
  MODERATOR
  ADMIN
}

enum DealerType {
  AUTOMOTORA
  RENT_A_CAR
}

enum DealerStatus {
  PENDING
  ACTIVE
  SUSPENDED
  REJECTED
}

enum DealerRole {
  OWNER
  MANAGER
  SALES
}

enum VehicleType {
  AUTO
  MOTO
  COMERCIAL
}

enum VehicleCategory {
  SEDAN
  HATCHBACK
  SUV
  STATION_WAGON
  COUPE
  DEPORTIVO
  VAN
  PICKUP
  MOTO_CALLE
  MOTO_TOURING
  MOTO_DEPORTIVA
  MOTO_CROSS
  SCOOTER
  CUATRIMOTO
  CAMION
  FURGON
  BUS
  MINIBUS
}

enum VehicleCondition {
  NUEVO
  USADO
}

enum FuelType {
  BENCINA
  DIESEL
  HIBRIDO
  ELECTRICO
  GAS
  OTRO
}

enum Transmission {
  MANUAL
  AUTOMATICA
  SEMIAUTOMATICA
}

enum ListingStatus {
  DRAFT
  ACTIVE
  PAUSED
  SOLD
  EXPIRED
  REJECTED
}

enum ReportReason {
  FRAUD
  INAPPROPRIATE
  DUPLICATE
  WRONG_INFO
  SOLD
  OTHER
}

enum ReportStatus {
  PENDING
  UNDER_REVIEW
  RESOLVED
  DISMISSED
}

// ==========================================
// Dealer Microsites
// ==========================================

model DealerSiteConfig {
  id                String    @id @default(cuid())
  dealerId          String    @unique
  isActive          Boolean   @default(false)
  activatedAt       DateTime?

  // Branding
  primaryColor      String    @default("#2563eb")
  accentColor       String    @default("#f97316")
  logo              String?
  logoPublicId      String?
  favicon           String?
  faviconPublicId   String?

  // Header/Footer
  headerStyle       String    @default("default") // default, centered, minimal
  footerStyle       String    @default("default") // default, minimal
  showWhatsAppButton Boolean  @default(true)
  showPhoneInHeader Boolean   @default(true)

  // Social links
  socialInstagram   String?
  socialFacebook    String?
  socialTiktok      String?
  socialYoutube     String?

  // SEO
  metaTitle         String?
  metaDescription   String?
  ogImage           String?
  ogImagePublicId   String?

  // Analytics
  googleAnalyticsId String?
  metaPixelId       String?

  // Contact
  contactEmail      String?
  contactPhone      String?
  contactWhatsApp   String?

  // Home page
  heroTitle         String?
  heroSubtitle      String?
  heroImage         String?
  heroImagePublicId String?
  showFeaturedVehicles Boolean @default(true)
  featuredVehiclesLimit Int    @default(8)

  // "Why Us" section
  whyUsTitle        String?
  whyUsSubtitle     String?
  whyUsFeatures     Json?   // [{icon, title, description}]

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  dealer            Dealer    @relation(fields: [dealerId], references: [id], onDelete: Cascade)
  domains           DealerDomain[]
  pages             DealerPage[]

  @@index([dealerId])
  @@index([isActive])
}

model DealerDomain {
  id                String       @id @default(cuid())
  siteConfigId      String
  domain            String       @unique
  isPrimary         Boolean      @default(false)
  isCustom          Boolean      @default(false)
  status            DomainStatus @default(PENDING)
  verifiedAt        DateTime?
  lastCheckedAt     DateTime?

  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  siteConfig        DealerSiteConfig @relation(fields: [siteConfigId], references: [id], onDelete: Cascade)

  @@index([siteConfigId])
  @@index([domain])
  @@index([status])
}

model DealerPage {
  id              String   @id @default(cuid())
  siteConfigId    String
  slug            String
  title           String
  content         Json     @default("[]")
  isPublished     Boolean  @default(false)
  order           Int      @default(0)
  showInNav       Boolean  @default(true)

  metaTitle       String?
  metaDescription String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  siteConfig      DealerSiteConfig @relation(fields: [siteConfigId], references: [id], onDelete: Cascade)

  @@unique([siteConfigId, slug])
  @@index([siteConfigId])
  @@index([isPublished])
}

model DealerLead {
  id             String     @id @default(cuid())
  dealerId       String
  vehicleId      String?
  conversationId String?    @unique

  name        String
  email       String
  phone       String?
  message     String

  source      LeadSource @default(MICROSITE)
  status      LeadStatus @default(NEW)
  readAt      DateTime?
  respondedAt DateTime?
  notes       String?

  // CRM Fields
  assignedToId   String?
  assignedTo     User?      @relation("AssignedLeads", fields: [assignedToId], references: [id])
  estimatedValue Int?
  lastContactAt  DateTime?
  nextFollowUp   DateTime?
  isDuplicate    Boolean    @default(false)

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  dealer       Dealer        @relation(fields: [dealerId], references: [id], onDelete: Cascade)
  vehicle      Vehicle?      @relation(fields: [vehicleId], references: [id], onDelete: SetNull)
  conversation Conversation? @relation(fields: [conversationId], references: [id], onDelete: SetNull)

  // CRM Relations
  activities     LeadActivity[]
  tasks          LeadTask[]
  opportunities  Opportunity[]
  testDrives     TestDrive[]
  preferences    LeadPreferences?

  @@index([dealerId])
  @@index([vehicleId])
  @@index([status])
  @@index([createdAt])
  @@index([assignedToId])
  @@index([conversationId])
}

enum DomainStatus {
  PENDING
  VERIFIED
  FAILED
}

enum LeadSource {
  MICROSITE
  PORTAL
  CHAT
  MANUAL
  WHATSAPP
  PHONE
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  CONVERTED
  LOST
}

// ============================================================================
// Tracking Events (Analytics y tracking de interacciones)
// ============================================================================

model TrackingEvent {
  id        String            @id @default(cuid())
  eventType TrackingEventType

  // Contexto
  vehicleId String?
  dealerId  String?
  source    String            @default("marketplace") // "marketplace" | "microsite"

  // Metadata de sesión
  userAgent  String?
  ipHash     String?  // Hash para anonimizar IP
  sessionId  String?  // Para agrupar eventos de misma sesión
  referrer   String?  // URL de referencia
  device     String?  // "mobile" | "tablet" | "desktop"
  regionId   String?  // Región del visitante (si se puede detectar)

  // Datos adicionales según tipo de evento
  metadata Json? // Para datos flexibles: { query, filters, platform, imageIndex, etc. }

  createdAt DateTime @default(now())

  vehicle Vehicle? @relation(fields: [vehicleId], references: [id], onDelete: SetNull)
  dealer  Dealer?  @relation(fields: [dealerId], references: [id], onDelete: SetNull)
  region  Region?  @relation(fields: [regionId], references: [id], onDelete: SetNull)

  @@index([vehicleId])
  @@index([dealerId])
  @@index([eventType])
  @@index([createdAt])
  @@index([source])
  @@index([sessionId])
  @@index([ipHash])
}

enum TrackingEventType {
  // Eventos de contacto
  WHATSAPP_CLICK
  PHONE_REVEAL
  PHONE_CALL
  CHAT_START
  CONTACT_FORM

  // Eventos de visualización
  PAGE_VIEW
  VEHICLE_VIEW
  DEALER_PROFILE_VIEW
  MICROSITE_HOME_VIEW
  IMAGE_GALLERY_VIEW

  // Eventos de interacción
  SEARCH_PERFORMED
  FILTER_APPLIED
  FAVORITE_ADDED
  FAVORITE_REMOVED
  SHARE_CLICK
}

// Mantener modelo anterior para compatibilidad (migración gradual)
model ContactEvent {
  id        String           @id @default(cuid())
  eventType ContactEventType

  // Contexto
  vehicleId String?
  dealerId  String?
  source    String           @default("marketplace") // "marketplace" | "microsite"

  // Metadata
  userAgent String?
  ipHash    String? // Hash para anonimizar IP
  sessionId String? // Para agrupar eventos de misma sesión

  createdAt DateTime @default(now())

  vehicle Vehicle? @relation(fields: [vehicleId], references: [id], onDelete: SetNull)
  dealer  Dealer?  @relation(fields: [dealerId], references: [id], onDelete: SetNull)

  @@index([vehicleId])
  @@index([dealerId])
  @@index([eventType])
  @@index([createdAt])
  @@index([source])
}

enum ContactEventType {
  WHATSAPP_CLICK
  PHONE_REVEAL
  PHONE_CALL
  CHAT_START
  CONTACT_FORM
}

// ============================================================================
// CRM System
// ============================================================================

model LeadActivity {
  id        String           @id @default(cuid())
  leadId    String
  lead      DealerLead       @relation(fields: [leadId], references: [id], onDelete: Cascade)
  userId    String
  user      User             @relation("LeadActivities", fields: [userId], references: [id])
  type      LeadActivityType
  content   String?
  metadata  Json?
  createdAt DateTime         @default(now())

  @@index([leadId])
  @@index([userId])
  @@index([createdAt])
}

enum LeadActivityType {
  NOTE
  CALL
  EMAIL
  WHATSAPP
  STATUS_CHANGE
  ASSIGNMENT
  TEST_DRIVE
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      NotificationType
  title     String
  message   String
  link      String?
  isRead    Boolean          @default(false)
  readAt    DateTime?
  metadata  Json?
  createdAt DateTime         @default(now())

  @@index([userId])
  @@index([userId, isRead])
  @@index([createdAt])
}

enum NotificationType {
  NEW_LEAD
  LEAD_ASSIGNED
  LEAD_STATUS_CHANGE
  NEW_MESSAGE
  FOLLOW_UP_REMINDER
  TEST_DRIVE_REMINDER
}

model LeadTask {
  id           String       @id @default(cuid())
  leadId       String
  lead         DealerLead   @relation(fields: [leadId], references: [id], onDelete: Cascade)
  assignedToId String
  assignedTo   User         @relation("AssignedTasks", fields: [assignedToId], references: [id])
  title        String
  description  String?
  dueAt        DateTime
  completedAt  DateTime?
  priority     TaskPriority @default(MEDIUM)
  notifiedAt   DateTime?
  createdAt    DateTime     @default(now())

  @@index([leadId])
  @@index([assignedToId])
  @@index([dueAt])
  @@index([completedAt])
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
}

model MessageTemplate {
  id        String          @id @default(cuid())
  dealerId  String
  dealer    Dealer          @relation(fields: [dealerId], references: [id], onDelete: Cascade)
  name      String
  channel   TemplateChannel
  subject   String?
  content   String
  variables String[]
  isActive  Boolean         @default(true)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  @@index([dealerId])
  @@index([dealerId, channel])
}

enum TemplateChannel {
  EMAIL
  WHATSAPP
}

model AutoResponseConfig {
  id              String  @id @default(cuid())
  dealerId        String  @unique
  dealer          Dealer  @relation(fields: [dealerId], references: [id], onDelete: Cascade)
  enabled         Boolean @default(false)
  emailTemplateId String?
  whatsappMessage String?
  delayMinutes    Int     @default(0)
}

model Opportunity {
  id                String            @id @default(cuid())
  leadId            String
  lead              DealerLead        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  vehicleId         String?
  vehicle           Vehicle?          @relation(fields: [vehicleId], references: [id])
  estimatedValue    Int
  probability       Int               @default(50)
  expectedCloseDate DateTime?
  status            OpportunityStatus @default(OPEN)
  notes             String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([leadId])
  @@index([vehicleId])
  @@index([status])
}

enum OpportunityStatus {
  OPEN
  WON
  LOST
}

model TestDrive {
  id          String          @id @default(cuid())
  leadId      String
  lead        DealerLead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  vehicleId   String
  vehicle     Vehicle         @relation(fields: [vehicleId], references: [id])
  scheduledAt DateTime
  duration    Int             @default(30)
  status      TestDriveStatus @default(SCHEDULED)
  notes       String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([leadId])
  @@index([vehicleId])
  @@index([scheduledAt])
  @@index([status])
}

enum TestDriveStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  NO_SHOW
}

model LeadPreferences {
  id          String     @id @default(cuid())
  leadId      String     @unique
  lead        DealerLead @relation(fields: [leadId], references: [id], onDelete: Cascade)
  brandIds    String[]
  modelIds    String[]
  minPrice    Int?
  maxPrice    Int?
  minYear     Int?
  maxYear     Int?
  vehicleType String?
  condition   String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}
