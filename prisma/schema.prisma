generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Dealer {
  id              String       @id @default(cuid())
  slug            String       @unique
  businessName    String
  tradeName       String
  rut             String       @unique
  type            DealerType
  email           String
  phone           String
  whatsapp        String?
  website         String?
  address         String
  regionId        String
  comunaId        String?
  logo            String?
  logoPublicId    String?
  banner          String?
  bannerPublicId  String?
  description     String?
  schedule        Json?
  status          DealerStatus @default(PENDING)
  verifiedAt      DateTime?
  rejectionReason String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  comuna          Comuna?      @relation(fields: [comunaId], references: [id])
  region          Region       @relation(fields: [regionId], references: [id])
  users           User[]
  vehicles        Vehicle[]
  siteConfig      DealerSiteConfig?
  leads           DealerLead[]

  @@index([status])
  @@index([type])
  @@index([regionId])
  @@index([slug])
}

model User {
  id                  String         @id @default(cuid())
  name                String?
  email               String?        @unique
  emailVerified       DateTime?
  image               String?
  password            String?
  phone               String?
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  banReason           String?
  bannedAt            DateTime?
  role                Role           @default(USER)
  suspendedUntil      DateTime?
  dealerId            String?
  dealerRole          DealerRole?
  accounts            Account[]
  buyerConversations  Conversation[] @relation("BuyerConversations")
  sellerConversations Conversation[] @relation("SellerConversations")
  favorites           Favorite[]
  messages            Message[]
  reportsMade         Report[]       @relation("ReportedBy")
  reportsResolved     Report[]       @relation("ResolvedBy")
  sessions            Session[]
  dealer              Dealer?        @relation(fields: [dealerId], references: [id])
  moderatedVehicles   Vehicle[]      @relation("ModeratedBy")
  vehicles            Vehicle[]

  @@index([email])
  @@index([role])
  @@index([dealerId])
}

model Vehicle {
  id              String           @id @default(cuid())
  title           String
  slug            String           @unique
  description     String?
  price           Int
  currency        String           @default("CLP")
  negotiable      Boolean          @default(false)
  vehicleType     VehicleType
  category        VehicleCategory
  condition       VehicleCondition
  brandId         String
  modelId         String
  year            Int
  mileage         Int
  fuelType        FuelType
  transmission    Transmission
  engineSize      String?
  color           String?
  doors           Int?
  seats           Int?
  plateEnding     String?
  technicalReview DateTime?
  regionId        String
  comunaId        String?
  contactPhone    String
  contactWhatsApp String?
  showPhone       Boolean          @default(true)
  status          ListingStatus    @default(ACTIVE)
  featured        Boolean          @default(false)
  views           Int              @default(0)
  userId          String
  publishedAt     DateTime         @default(now())
  expiresAt       DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  moderatedAt     DateTime?
  moderatedById   String?
  rejectionReason String?
  dealerId        String?
  versionId       String?
  conversations   Conversation[]
  favorites       Favorite[]
  reports         Report[]
  brand           Brand            @relation(fields: [brandId], references: [id])
  comuna          Comuna?          @relation(fields: [comunaId], references: [id])
  dealer          Dealer?          @relation(fields: [dealerId], references: [id])
  model           Model            @relation(fields: [modelId], references: [id])
  moderatedBy     User?            @relation("ModeratedBy", fields: [moderatedById], references: [id])
  region          Region           @relation(fields: [regionId], references: [id])
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  version         Version?         @relation(fields: [versionId], references: [id])
  images          VehicleImage[]
  dealerLeads     DealerLead[]

  @@index([userId])
  @@index([brandId])
  @@index([modelId])
  @@index([versionId])
  @@index([regionId])
  @@index([vehicleType])
  @@index([status])
  @@index([price])
  @@index([year])
  @@index([publishedAt])
  @@index([slug])
  @@index([dealerId])
}

model VehicleImage {
  id        String   @id @default(cuid())
  url       String
  publicId  String
  isPrimary Boolean  @default(false)
  order     Int      @default(0)
  vehicleId String
  createdAt DateTime @default(now())
  vehicle   Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId])
}

model Brand {
  id           String        @id @default(cuid())
  name         String        @unique
  slug         String        @unique
  logo         String?
  vehicleTypes VehicleType[] @default([])
  models       Model[]
  vehicles     Vehicle[]

  @@index([slug])
}

model Model {
  id           String        @id @default(cuid())
  name         String
  slug         String
  brandId      String
  vehicleTypes VehicleType[] @default([])
  brand        Brand         @relation(fields: [brandId], references: [id], onDelete: Cascade)
  vehicles     Vehicle[]
  versions     Version[]

  @@unique([brandId, slug])
  @@index([brandId])
}

model Version {
  id           String    @id @default(cuid())
  name         String
  slug         String
  engineSize   String?
  horsePower   Int?
  transmission String?
  drivetrain   String?
  trimLevel    String?
  modelId      String
  vehicles     Vehicle[]
  model        Model     @relation(fields: [modelId], references: [id], onDelete: Cascade)

  @@unique([modelId, slug])
  @@index([modelId])
}

model Region {
  id       String    @id @default(cuid())
  name     String    @unique
  slug     String    @unique
  order    Int
  comunas  Comuna[]
  dealers  Dealer[]
  vehicles Vehicle[]

  @@index([slug])
}

model Comuna {
  id       String    @id @default(cuid())
  name     String
  slug     String
  regionId String
  region   Region    @relation(fields: [regionId], references: [id], onDelete: Cascade)
  dealers  Dealer[]
  vehicles Vehicle[]

  @@unique([regionId, slug])
  @@index([regionId])
}

model Favorite {
  id        String   @id @default(cuid())
  userId    String
  vehicleId String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  vehicle   Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@unique([userId, vehicleId])
  @@index([userId])
  @@index([vehicleId])
}

model Conversation {
  id                 String    @id @default(cuid())
  vehicleId          String
  buyerId            String
  sellerId           String
  lastMessageAt      DateTime  @default(now())
  buyerUnreadCount   Int       @default(0)
  sellerUnreadCount  Int       @default(0)
  isArchivedByBuyer  Boolean   @default(false)
  isArchivedBySeller Boolean   @default(false)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  buyer              User      @relation("BuyerConversations", fields: [buyerId], references: [id], onDelete: Cascade)
  seller             User      @relation("SellerConversations", fields: [sellerId], references: [id], onDelete: Cascade)
  vehicle            Vehicle   @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  messages           Message[]

  @@unique([buyerId, vehicleId])
  @@index([buyerId])
  @@index([sellerId])
  @@index([lastMessageAt])
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  senderId       String
  content        String
  isRead         Boolean      @default(false)
  readAt         DateTime?
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User         @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
}

model Report {
  id           String       @id @default(cuid())
  vehicleId    String
  reporterId   String
  reason       ReportReason
  description  String?
  status       ReportStatus @default(PENDING)
  resolvedById String?
  resolvedAt   DateTime?
  resolution   String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  reporter     User         @relation("ReportedBy", fields: [reporterId], references: [id])
  resolvedBy   User?        @relation("ResolvedBy", fields: [resolvedById], references: [id])
  vehicle      Vehicle      @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId])
  @@index([reporterId])
  @@index([status])
  @@index([createdAt])
}

model SiteConfig {
  id                    String   @id @default("default")
  siteName              String   @default("AutoExplora.cl")
  siteTagline           String?
  logo                  String?
  favicon               String?
  contactEmail          String?
  contactPhone          String?
  whatsapp              String?
  address               String?
  facebook              String?
  instagram             String?
  twitter               String?
  youtube               String?
  heroTitle             String?
  heroSubtitle          String?
  footerText            String?
  updatedAt             DateTime @updatedAt
  accentColor           String   @default("#f97316")
  footerLogoSize        String   @default("md")
  googleAnalyticsId     String?
  headerLogoSize        String   @default("md")
  maintenanceMessage    String?
  maintenanceMode       Boolean  @default(false)
  maxImagesPerVehicle   Int      @default(10)
  metaDescription       String?
  primaryColor          String   @default("#2563eb")
  showSiteNameInFooter  Boolean  @default(true)
  showSiteNameInHeader  Boolean  @default(true)
  showWhatsAppButton    Boolean  @default(true)
  ctaButtonText         String   @default("Publicar mi vehículo")
  ctaSubtitle           String   @default("Publica tu auto, moto o vehículo comercial en minutos y conecta con compradores interesados.")
  ctaTitle              String   @default("¿Listo para vender tu vehículo?")
  featuredVehiclesLimit Int      @default(8)
  popularBrandsLimit    Int      @default(12)
  recentVehiclesLimit   Int      @default(8)
  showCTASection        Boolean  @default(true)
  showFeaturedVehicles  Boolean  @default(true)
  showPopularBrands     Boolean  @default(true)
  showRecentVehicles    Boolean  @default(true)
  showTopDealers        Boolean  @default(true)
  showWhyChooseUs       Boolean  @default(true)
  topDealersLimit       Int      @default(6)
  whyChooseUsSubtitle   String   @default("Somos el marketplace de vehículos más confiable de Chile")
  whyChooseUsTitle      String   @default("¿Por qué elegir AutoExplora.cl?")
}

enum Role {
  USER
  MODERATOR
  ADMIN
}

enum DealerType {
  AUTOMOTORA
  RENT_A_CAR
}

enum DealerStatus {
  PENDING
  ACTIVE
  SUSPENDED
  REJECTED
}

enum DealerRole {
  OWNER
  MANAGER
  SALES
}

enum VehicleType {
  AUTO
  MOTO
  COMERCIAL
}

enum VehicleCategory {
  SEDAN
  HATCHBACK
  SUV
  STATION_WAGON
  COUPE
  DEPORTIVO
  VAN
  PICKUP
  MOTO_CALLE
  MOTO_TOURING
  MOTO_DEPORTIVA
  MOTO_CROSS
  SCOOTER
  CUATRIMOTO
  CAMION
  FURGON
  BUS
  MINIBUS
}

enum VehicleCondition {
  NUEVO
  USADO
}

enum FuelType {
  BENCINA
  DIESEL
  HIBRIDO
  ELECTRICO
  GAS
  OTRO
}

enum Transmission {
  MANUAL
  AUTOMATICA
  SEMIAUTOMATICA
}

enum ListingStatus {
  DRAFT
  ACTIVE
  PAUSED
  SOLD
  EXPIRED
  REJECTED
}

enum ReportReason {
  FRAUD
  INAPPROPRIATE
  DUPLICATE
  WRONG_INFO
  SOLD
  OTHER
}

enum ReportStatus {
  PENDING
  UNDER_REVIEW
  RESOLVED
  DISMISSED
}

// ==========================================
// Dealer Microsites
// ==========================================

model DealerSiteConfig {
  id                String    @id @default(cuid())
  dealerId          String    @unique
  isActive          Boolean   @default(false)
  activatedAt       DateTime?

  // Branding
  primaryColor      String    @default("#2563eb")
  accentColor       String    @default("#f97316")
  logo              String?
  logoPublicId      String?
  favicon           String?
  faviconPublicId   String?

  // Header/Footer
  headerStyle       String    @default("default") // default, centered, minimal
  footerStyle       String    @default("default") // default, minimal
  showWhatsAppButton Boolean  @default(true)
  showPhoneInHeader Boolean   @default(true)

  // Social links
  socialInstagram   String?
  socialFacebook    String?
  socialTiktok      String?
  socialYoutube     String?

  // SEO
  metaTitle         String?
  metaDescription   String?
  ogImage           String?
  ogImagePublicId   String?

  // Analytics
  googleAnalyticsId String?
  metaPixelId       String?

  // Contact
  contactEmail      String?
  contactPhone      String?
  contactWhatsApp   String?

  // Home page
  heroTitle         String?
  heroSubtitle      String?
  heroImage         String?
  heroImagePublicId String?
  showFeaturedVehicles Boolean @default(true)
  featuredVehiclesLimit Int    @default(8)

  // "Why Us" section
  whyUsTitle        String?
  whyUsSubtitle     String?
  whyUsFeatures     Json?   // [{icon, title, description}]

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  dealer            Dealer    @relation(fields: [dealerId], references: [id], onDelete: Cascade)
  domains           DealerDomain[]
  pages             DealerPage[]

  @@index([dealerId])
  @@index([isActive])
}

model DealerDomain {
  id                String       @id @default(cuid())
  siteConfigId      String
  domain            String       @unique
  isPrimary         Boolean      @default(false)
  isCustom          Boolean      @default(false)
  status            DomainStatus @default(PENDING)
  verifiedAt        DateTime?
  lastCheckedAt     DateTime?

  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  siteConfig        DealerSiteConfig @relation(fields: [siteConfigId], references: [id], onDelete: Cascade)

  @@index([siteConfigId])
  @@index([domain])
  @@index([status])
}

model DealerPage {
  id              String   @id @default(cuid())
  siteConfigId    String
  slug            String
  title           String
  content         Json     @default("[]")
  isPublished     Boolean  @default(false)
  order           Int      @default(0)
  showInNav       Boolean  @default(true)

  metaTitle       String?
  metaDescription String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  siteConfig      DealerSiteConfig @relation(fields: [siteConfigId], references: [id], onDelete: Cascade)

  @@unique([siteConfigId, slug])
  @@index([siteConfigId])
  @@index([isPublished])
}

model DealerLead {
  id          String     @id @default(cuid())
  dealerId    String
  vehicleId   String?

  name        String
  email       String
  phone       String?
  message     String

  source      String     @default("microsite")
  status      LeadStatus @default(NEW)
  readAt      DateTime?
  respondedAt DateTime?
  notes       String?

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  dealer      Dealer     @relation(fields: [dealerId], references: [id], onDelete: Cascade)
  vehicle     Vehicle?   @relation(fields: [vehicleId], references: [id], onDelete: SetNull)

  @@index([dealerId])
  @@index([vehicleId])
  @@index([status])
  @@index([createdAt])
}

enum DomainStatus {
  PENDING
  VERIFIED
  FAILED
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  CONVERTED
  LOST
}
